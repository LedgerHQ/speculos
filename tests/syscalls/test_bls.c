#include <err.h>
#include <setjmp.h>
#include <stdarg.h>
#include <stddef.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>

#include <blst.h>
#include <cmocka.h>

#include "bolos/cx.h"
#include "bolos/cx_bls.h"
#include "bolos/cxlib.h"
#include "utils.h"

#define BLS_DERIVE_SECRET (0x80)
#define BLS_DST_AUG       ("BLS_SIG_BLS12381G2_XMD:SHA-256_SSWU_RO_AUG_")
#define BLS_HASH_TO_FIELD_DST                                                  \
  ("QUUX-V01-CS02-with-BLS12381G2_XMD:SHA-256_SSWU_RO_")
#define BLS_ETH_DST ("BLS_SIG_BLS12381G2_XMD:SHA-256_SSWU_RO_POP_")

typedef enum { BLS_DERIVE = 0, BLS_SIGN } bls_op_t;

typedef struct {
  const char *dst;
  const char *seed;
  const char *message;
  const char *signature;
  const char *public_key;
} bls_test_vector;

typedef struct {
  const char *message;
  const char *hash;
} bls_hash_to_field_test_vector;

/* Generated from Chia-Network implementation */
static const bls_test_vector chia_test_vectors[] = {
  { .dst = "BLS_SIG_BLS12381G2_XMD:SHA-256_SSWU_RO_AUG_",
    .seed = "5995ade9484e143311af5f845e0feed6174824fcb33c0384f925cbd80077385d",
    .message =
        "416f403f90f0bf7e3910ef188d37a41f08038d2a60cfcd16e6e4098cd53c984cbbfe"
        "c5159c936e6ab297498a5c0b2cb3cc80c629ed689a795d2ba4113e4f3d31",
    .signature =
        "b79289df14b64001ac2f371ccba402a25ac5bd86ad4c7c131014b9278a273b2f6a28"
        "2a084163c14d9f4be917760ebca4184c99bb22563aea6a1aae1318f5f0c4450bfaee"
        "63088015ee220e688f39e4d1d7d3c5f2aed1dc59c599d3314d091c42",
    .public_key = "ae570cf42a69ea5fb079ce85fe871bb4aaa48b4caef49471"
                  "7c30f0310476c24f811b45990a196d7f5fa883c8aefde397" },
  { .dst = "BLS_SIG_BLS12381G2_XMD:SHA-256_SSWU_RO_AUG_",
    .seed = "e113c0959cf960cb9c62d66dd57909fdc14bc50c88dfea53d795f02793a99d51",
    .message =
        "5be644e73ea26455fd85a22c8e68689f7f30e6047594214c8754f03f924c94f3ba36"
        "58a746f6fc1862ddce6458aa7b6d4788290b16548fc9447a727ae4087598",
    .signature =
        "b720c14744f881d6a0d8743607fabcb5ad2e680084483ee573a7abfbfa3993ab0631c"
        "1f98f6b7f3b8b037dce7ea7ca9d135046d60c2414436e53f2c3863fedb47d61194e13"
        "19617aecc8a6e85fcd9a4898e657d9ce11eabc21d721d4f4f5e3d0",
    .public_key = "988ab4e4129f42abf42cba3fbe285444ac36977db23c2bfe"
                  "462e7f29867b7885eab1297e69e7407799ed38c31f9dfd42" },
  { .dst = "BLS_SIG_BLS12381G2_XMD:SHA-256_SSWU_RO_AUG_",
    .seed = "c59a0ecac8fed3b2af24514b25a15dbfe9a9121a28badb1e81eabd14729c88dd",
    .message =
        "af3d7039707f1d79f710dd4964dadc37a3b6955e451b8d769dc8b789cd14cab64eff"
        "baa05ca278ae6b91f6019481b31eb38c48ea9dae0762da933c7bba3f49d6",
    .signature =
        "b010738b8f6a8c562f7f36bcda899519cd8f7af1075052b55f2f53acee6152999339"
        "f88adf5ca63937567a63f39f69c403d36e7b4238201213de53a08547999fc69dc405"
        "d8a0fd6047512f5c6159503fd3a97b196c55bbccd593ed7111dacb85",
    .public_key = "ab8296beb38cf8d35e0c6724a2642a3c8d940f84762a8335"
                  "f9349bcf7dd8b9879c350f4e62889c5d333dff076fb28a88" },
  { .dst = "BLS_SIG_BLS12381G2_XMD:SHA-256_SSWU_RO_AUG_",
    .seed = "5c78c2e03892bcdc49339291c90d1f7e2b076d0bf8a811bf987fce591daceaa3",
    .message =
        "62f14738b0763840be9b40a8236e99eedb4593c3e093d2e64079fb305d69ad7264ed"
        "6fc5468625e1729c190556a7df47d6368e7e7b796b7d15708fe3f913d077",
    .signature =
        "960e8c37172616cc336d86593db60e7469cc0b635d32b88d8c192b3ce7bcb59fe241"
        "f0cb787b6e138ba3567e81ef8cb317bf7fdbbb4f0f8996ae89bc70e8e6b653963607"
        "7b7c2ce59857d55b58aa1d47fac81094bf5590d911ec9438f3d42d23",
    .public_key = "b45aa4de6c1e5fe97adb3558b34baf914d7bb0f6cab6334f"
                  "890263edbae5ad16014451e815e185c9476070fac17dd190" },
  { .dst = "BLS_SIG_BLS12381G2_XMD:SHA-256_SSWU_RO_NUL_",
    .seed = "a78394e80bb3b8133a9b2a11306709e831ac0a0fa94040022bdca61876f57ef6",
    .message =
        "c1f9a3efe78a7a3d9a8626acd265accf97ec0e6a3319ccabb6c3fad14ab76fad46ea0a"
        "a69228767f5aa51283f25a16290523801086a0c884ead69e65e17c00885ed582420920"
        "c9d36129eaf3fed417855d26c1fc860c2687fca9e02e1e208d3b1961ef0bc91d08be5f"
        "4b22c4055feb65b20c7f11af08e79cce6b36036ce98bc4afcc956a7f5d0f5a1688172f"
        "878f33c799a450eac3ba4e4e710370f36f70caa28147066186d71e557b37d27417872c"
        "f9e60adc190a5862fa00ab28d832748cf0fcf2bd62e1860794",
    .signature =
        "85efb8d7743b9a3cb931bc8e3cec72640ce5b796af774b1b334775e210150c57894321"
        "89c9f4c920489ae0646038189402017d102454b581a568052f4ed45cafde2a42b17e4a"
        "12d22df8387cf5ffe4ed6cebace665b2b05bf3784f95732e0e8c",
    .public_key = "" },
  { .dst = "BLS_SIG_BLS12381G2_XMD:SHA-256_SSWU_RO_NUL_",
    .seed = "4dd2fd906285ba24ed8e4f1bbe0da71aab4ef0b7b500a1805dca1f5d3c958fac",
    .message =
        "a169671a8716d3796b941bacfbba1e05b7b41251718fce879ba2040707607ffab796c7"
        "71d19ebae1c6cbb092295e3e930cc1c5ee9534de65a7dcf51ecf1c4c25e4d46d1f2789"
        "d9d8f398b491036c2d7a1bc9ee316f012309b4497724c13eb53809a57e51b9bb34f2fc"
        "07ba92c7204c13cd24201c1de4e7a39b30c32ca07f74eee0d5963258d80ea8f97a66a7"
        "78a216f4b06254552074bd7ccd017bf80a96123c838191f7607ec505a8e72f50c10286"
        "58329a138b41ec1b2eba797af11ec8a87ef32b538732c6ab4f",
    .signature =
        "8a200e288e88d0e1a60b6a94864465f65016af958a2af902447859b83073afc04f917b"
        "5f9844d41c5f6331176d01e78605943ef712de457e63b757e985d85887e9e4c6c49a4c"
        "c4dd86fb7ee0cd36f206db3a021f2610d7d9551582b469e476a2",
    .public_key = "" },
  { .dst = "BLS_SIG_BLS12381G2_XMD:SHA-256_SSWU_RO_NUL_",
    .seed = "a003866a4febd6df34c26b763e5346083ad9335a1ca590ebdd9c60b25d113f7c",
    .message =
        "9482e2f87654e987f480eab01348d98df700be32bf8741f4d4350f59d5d2914506fca2"
        "0437aca4290cf6912f0b2171f66ae535a12e498af75f898494a6b7a959deb4c5a460f0"
        "73a2d834ebcaea401128639d7170f5bbface00a8a3ec2da5a198fdea99e760565939df"
        "a3899d8b3b2f1769942fce5bc729110ea373df8742b9c488dc6e791c9c8ad84813f870"
        "e16cbb423b28bb50918d0510a1960ed23457391a445274e95f7865d6cbfc243043561c"
        "8d1feaf2a34fac6a4b05460efa2d6685068c12ba1e0044d3ae",
    .signature =
        "ae71f13e21dda31951c39153b9ee404bcbf6bfb5214fcd301891fd6146797ff08de053"
        "a3f765f0b32fd9316ff2df7ea10b4b3d198c6860e18ed95bd7362bed12c6a7a1dbce9e"
        "2dd63f0f35dcb53c0846c859e477fe9aa2a8b9436ce93ebc0645",
    .public_key = "" },
  { .dst = "BLS_SIG_BLS12381G2_XMD:SHA-256_SSWU_RO_NUL_",
    .seed = "e4aaf698ddda3a848e66a756b4f9d0d246002112d15c5375c9838875100c2d78",
    .message =
        "5c12349e2353f21af136f4fd33c12108b7a5a61c70f0c22b854670169b28a5f65c6b00"
        "33d39e8e52de35c72a9793cd81d13f3bc82f3e2522cb40f27164b22d5f76bdba502e9e"
        "73b506f8ead4c838a68a7f11281041789e4d2e6e424909b3aa1c8a97a85b7ccfc1c032"
        "f16dc0b0f11a76a399f53cb40f46bac44f07da60e50b581850ef126f10cdfdcd7682c5"
        "f1caaf192d13c97937c02163bf25eb7bc84cada2a078abd9891f9c83f7b054e343788c"
        "922638fa0a54fd47f5c4e64508d0654bce20f338fe57856e84",
    .signature =
        "b97e4cd93f7dcf70a05449cff2dc999b87b39a6a9563678ca57c7a3ca0ed1fc9f717b8"
        "2336ee0e352ba177cf96744bd81175592b1e556814a83c9bafe20d09c4d63981dceefe"
        "d7c7c0eea1529d53bc9b8f0a81f6a0425ab05680bd0f6324645e",
    .public_key = "" }
};

static const bls_hash_to_field_test_vector hash_to_field_test_vectors[] = {
  { .message = "",
    .hash = "03dbc2cce174e91ba93cbb08f26b917f98194a2ea08d1cce75b2b9cc9f21689d80"
            "bd79b594a613d0a68eb807dfdc1cf8"
            "05a2acec64114845711a54199ea339abd125ba38253b70a92c876df10598bd1986"
            "b739cad67961eb94f7076511b3b39a"
            "02f99798e8a5acdeed60d7e18e9120521ba1f47ec090984662846bc825de191b5b"
            "7641148c0dbc237726a334473eee94"
            "145a81e418d4010cc027a68f14391b30074e89e60ee7a22f87217b2f6eb0c4b94c"
            "9115b436e6fa4607e95a98de30a435" },
  { .message = "abc",
    .hash = "15f7c0aa8f6b296ab5ff9c2c7581ade64f4ee6f1bf18f55179ff44a2cf355fa53d"
            "d2a2158c5ecb17d7c52f63e7195771"
            "01c8067bf4c0ba709aa8b9abc3d1cef589a4758e09ef53732d670fd8739a7274e1"
            "11ba2fcaa71b3d33df2a3a0c8529dd"
            "187111d5e088b6b9acfdfad078c4dacf72dcd17ca17c82be35e79f8c372a693f60"
            "a033b461d81b025864a0ad051a06e4"
            "08b852331c96ed983e497ebc6dee9b75e373d923b729194af8e72a051ea586f353"
            "8a6ebb1e80881a082fa2b24df9f566" },
  { .message = "abcdef0123456789",
    .hash = "0313d9325081b415bfd4e5364efaef392ecf69b087496973b229303e1816d20809"
            "71470f7da112c4eb43053130b785e1"
            "062f84cb21ed89406890c051a0e8b9cf6c575cf6e8e18ecf63ba86826b0ae02548"
            "d83b483b79e48512b82a6c0686df8f"
            "1739123845406baa7be5c5dc74492051b6d42504de008c635f3535bb831d478a34"
            "1420e67dcc7b46b2e8cba5379cca97"
            "01897665d9cb5db16a27657760bbea7951f67ad68f8d55f7113f24ba6ddd82caef"
            "240a9bfa627972279974894701d975" },
  { .message = "q128_"
               "qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"
               "qqqqqqqqqqqqqqqqqqqq"
               "qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq",
    .hash = "025820cefc7d06fd38de7d8e370e0da8a52498be9b53cba9927b2ef5c6de1e12e1"
            "2f188bbc7bc923864883c57e49e253"
            "034147b77ce337a52e5948f66db0bab47a8d038e712123bb381899b6ab5ad20f02"
            "805601e6104c29df18c254b8618c7b"
            "0930315cae1f9a6017c3f0c8f2314baa130e1cf13f6532bff0a8a1790cd70af918"
            "088c3db94bda214e896e1543629795"
            "10c4df2cacf67ea3cb3108b00d4cbd0b3968031ebc8eac4b1ebcefe84d6b715fde"
            "66bef0219951ece29d1facc8a520ef" },
};

static void test_bls_vector(const bls_test_vector *v, bls_op_t op)
{
  uint8_t mode;
  size_t message_len = 0;
  uint8_t expected_pk[CX_BLS_BLS12381_PARAM_LEN] = { 0 };
  uint8_t public_key[CX_BLS_BLS12381_PARAM_LEN] = { 0 };
  uint8_t seed[32];
  uint8_t salt[] = { 'B', 'L', 'S', '-', 'S', 'I', 'G', '-', 'K', 'E',
                     'Y', 'G', 'E', 'N', '-', 'S', 'A', 'L', 'T', '-' };
  uint8_t message[128];
  uint8_t hash[CX_BLS_BLS12381_PARAM_LEN * 4];
  uint8_t signature[BLS_COMPRESSED_SIG_LEN];
  uint8_t expected_signature[BLS_COMPRESSED_SIG_LEN];
  cx_ecfp_384_private_key_t private_key;

  hexstr2bin(v->seed, seed, sizeof(seed));

  if (strcmp(v->dst + 39, "AUG_") == 0) {
    mode = CX_BLS_SIGN_AUG;
  } else if (strcmp(v->dst + 39, "POP_") == 0) {
    mode = CX_BLS_SIGN_POP;
  } else {
    mode = CX_BLS_BASE;
  }

  mode |= BLS_DERIVE_SECRET;
  assert_int_equal(sys_cx_bls12381_key_gen(mode, seed, sizeof(seed), salt,
                                           sizeof(salt), NULL, 0, &private_key,
                                           public_key, sizeof(public_key)),
                   CX_OK);
  hexstr2bin(v->public_key, expected_pk, strlen(v->public_key));
  assert_memory_equal(public_key, expected_pk, sizeof(expected_pk));

  if (op == BLS_SIGN) {
    if ((mode & CX_BLS_SIGN_AUG) == CX_BLS_SIGN_AUG) {
      memcpy(message, public_key, sizeof(public_key));
      message_len = sizeof(public_key);
    }
    hexstr2bin(v->message, message + message_len, strlen(v->message));
    message_len += strlen(v->message) / 2;
    assert_int_equal(sys_cx_hash_to_field(message, message_len,
                                          (const uint8_t *)v->dst,
                                          strlen(v->dst), hash, sizeof(hash)),
                     CX_OK);

    assert_int_equal(sys_ox_bls12381_sign(&private_key, hash, sizeof(hash),
                                          signature, sizeof(signature)),
                     CX_OK);
    hexstr2bin(v->signature, expected_signature, sizeof(expected_signature));
    assert_memory_equal(signature, expected_signature,
                        sizeof(expected_signature));
  }
}

static void
test_bls_hash_to_field_vector(const bls_hash_to_field_test_vector *v)
{
  uint8_t dst[51] = { 0 };
  uint8_t msg[134] = { 0 };
  uint8_t hash[CX_BLS_BLS12381_PARAM_LEN * 4];
  uint8_t expected_hash[CX_BLS_BLS12381_PARAM_LEN * 4];
  size_t msg_len, dst_len, hash_len;

  msg_len = strlen(v->message);
  dst_len = strlen(BLS_HASH_TO_FIELD_DST);
  hash_len = CX_BLS_BLS12381_PARAM_LEN * 4;

  strcpy((char *)dst, BLS_HASH_TO_FIELD_DST);
  strcpy((char *)msg, v->message);
  hexstr2bin(v->hash, expected_hash, sizeof(expected_hash));
  assert_int_equal(
      sys_cx_hash_to_field(msg, msg_len, dst, dst_len, hash, hash_len), CX_OK);
  assert_memory_equal(hash, expected_hash, sizeof(expected_hash));
}

static void test_bls_key_gen_aug(void **state __attribute__((unused)))
{
  unsigned int i;

  for (i = 0; i < ARRAY_SIZE(chia_test_vectors); i++) {
    test_bls_vector(&chia_test_vectors[i], BLS_DERIVE);
  }
}

static void test_bls_sign_aug(void **state __attribute__((unused)))
{
  unsigned int i;

  for (i = 0; i < ARRAY_SIZE(chia_test_vectors); i++) {
    test_bls_vector(&chia_test_vectors[i], BLS_SIGN);
  }
}

static void test_bls_hash_to_field(void **state __attribute__((unused)))
{
  unsigned int i;

  for (i = 0; i < ARRAY_SIZE(hash_to_field_test_vectors); i++) {
    test_bls_hash_to_field_vector(&hash_to_field_test_vectors[i]);
  }
}

static void test_bls_fp2_sqrt_ratio(void **state __attribute__((unused)))
{
  uint8_t expected_sqrt[CX_BLS_BLS12381_PARAM_LEN * 2] = {
    0x0d, 0xba, 0x06, 0x35, 0xd3, 0x21, 0xe8, 0xbd, 0xfa, 0x28, 0x54, 0xb5,
    0x77, 0xef, 0x0d, 0xc8, 0x57, 0xb0, 0x6a, 0x40, 0x64, 0x0a, 0x9e, 0x6e,
    0x5a, 0x43, 0xe1, 0x37, 0x8a, 0xcc, 0xa0, 0x17, 0xd8, 0xaf, 0xc3, 0x0d,
    0xb5, 0x2c, 0x22, 0xf6, 0x97, 0x1b, 0xa7, 0x19, 0x96, 0x6f, 0xa8, 0xb8,
    0x17, 0x1e, 0x95, 0x82, 0x3e, 0x9e, 0x11, 0xd3, 0x0b, 0x3b, 0x24, 0xa3,
    0x64, 0xe5, 0x22, 0x1e, 0xc6, 0xe5, 0x5e, 0xfa, 0x55, 0x48, 0xf8, 0xb4,
    0xb1, 0xe7, 0xa7, 0x85, 0x87, 0x7a, 0xb1, 0xff, 0x36, 0x6a, 0xd1, 0xcd,
    0x0e, 0xeb, 0x30, 0x78, 0x71, 0xc6, 0xd5, 0xa5, 0x97, 0x1a, 0xde, 0xb9
  };
  uint8_t u[CX_BLS_BLS12381_PARAM_LEN * 2] = {
    0x14, 0xa5, 0x73, 0x8c, 0x7a, 0x05, 0x35, 0xa4, 0x44, 0x49, 0xb7, 0x7e,
    0xda, 0x56, 0x7c, 0x18, 0x00, 0x16, 0xf2, 0x99, 0x11, 0xd9, 0x28, 0x5c,
    0xd8, 0xe7, 0x2b, 0xc3, 0xc2, 0xac, 0x9b, 0x92, 0x3e, 0x41, 0xd2, 0x01,
    0x8f, 0x71, 0x03, 0xb8, 0x83, 0xc2, 0xa4, 0xc5, 0xfa, 0x50, 0xda, 0xd3,
    0x15, 0xa2, 0x5d, 0xcf, 0x1e, 0x1d, 0x6b, 0x29, 0xb6, 0x6f, 0x39, 0x04,
    0xd6, 0x1e, 0x78, 0x52, 0x03, 0x66, 0xbb, 0x91, 0xb9, 0xbd, 0xc2, 0x5d,
    0xc4, 0xbb, 0x09, 0x32, 0xc5, 0x36, 0x67, 0x97, 0x9f, 0x9e, 0xc6, 0x8d,
    0x7b, 0xbc, 0x5c, 0x78, 0xd4, 0x4e, 0xe0, 0xb2, 0xbf, 0x52, 0x9c, 0xe8
  };
  uint8_t v[CX_BLS_BLS12381_PARAM_LEN * 2] = {
    0x10, 0xae, 0x6f, 0x8a, 0xc0, 0xca, 0x5c, 0x64, 0x7e, 0xa8, 0x94, 0xf4,
    0x0d, 0xa4, 0x01, 0x37, 0x18, 0x6a, 0x4e, 0x55, 0x63, 0x68, 0x62, 0x41,
    0xe8, 0x88, 0x52, 0x94, 0xad, 0xc2, 0x77, 0xdd, 0x66, 0x4e, 0xf1, 0x1f,
    0x79, 0xc7, 0xe1, 0x1f, 0xe4, 0xf3, 0xfe, 0x77, 0x20, 0x89, 0xe5, 0x1a,
    0x10, 0x6f, 0x3c, 0x4d, 0xb4, 0xd4, 0x88, 0x23, 0x27, 0x16, 0x47, 0x90,
    0x77, 0x52, 0xea, 0x94, 0x14, 0x9e, 0x44, 0x35, 0xa6, 0x49, 0xa7, 0x8e,
    0x62, 0x13, 0xdb, 0xdb, 0x2d, 0x62, 0xbe, 0x8c, 0xc1, 0xc4, 0x76, 0x34,
    0x5a, 0x5a, 0x60, 0x24, 0xda, 0xfb, 0x6c, 0xb5, 0xb9, 0xa0, 0x9d, 0x20
  };

  uint8_t res[CX_BLS_BLS12381_PARAM_LEN * 2];
  bool is_square;
  blst_fp2 fp2_u, fp2_v, fp2_res;

  cx_bls_fp2_from_bendian(&fp2_u, u, u + CX_BLS_BLS12381_PARAM_LEN);
  cx_bls_fp2_from_bendian(&fp2_v, v, v + CX_BLS_BLS12381_PARAM_LEN);
  is_square = cx_bls_fp2_sqrt_ratio(&fp2_res, &fp2_u, &fp2_v);
  cx_bls_bendian_from_fp2(res, res + CX_BLS_BLS12381_PARAM_LEN, &fp2_res);
  assert_true(is_square);
  assert_memory_equal(res, expected_sqrt, sizeof(expected_sqrt));
}

static void test_bls_fp2_pow(void **state __attribute__((unused)))
{
  uint8_t a[BLS_FIELD_EXT_LEN] = {
    0x05, 0x9b, 0x9f, 0xd4, 0x2e, 0x0a, 0xc1, 0xce, 0x16, 0x17, 0x4b, 0x9c,
    0xe1, 0x8c, 0xa5, 0x84, 0xec, 0x58, 0xef, 0xc0, 0x41, 0x86, 0x03, 0x8a,
    0x64, 0xa1, 0x65, 0x6c, 0x6d, 0xd6, 0x3d, 0xab, 0x3c, 0x1e, 0x31, 0x00,
    0x79, 0x44, 0xa9, 0x80, 0x8b, 0x3d, 0x6b, 0xb4, 0x8f, 0x72, 0xfb, 0x13,
    0x14, 0x7f, 0x55, 0xb3, 0x60, 0xbd, 0x07, 0xd1, 0x48, 0x45, 0xaa, 0x68,
    0x4e, 0x5b, 0x59, 0x7f, 0x11, 0x3d, 0x8f, 0x47, 0x9f, 0x2a, 0xd7, 0x90,
    0x09, 0xf1, 0xdb, 0xef, 0xde, 0x2e, 0x91, 0x90, 0x6f, 0x8c, 0x15, 0xfc,
    0xc5, 0x69, 0x58, 0x6a, 0x41, 0x5a, 0xdd, 0x7c, 0x3a, 0x85, 0x27, 0x13
  };

  uint8_t exponent[] = {
    0x00, 0x54, 0x86, 0xf4, 0x97, 0x18, 0x6b, 0xf8, 0xe9, 0x7a, 0x4f, 0x1d,
    0x54, 0x45, 0xe4, 0xbd, 0x3c, 0x5b, 0x92, 0x1c, 0xa1, 0xce, 0x08, 0xd6,
    0x8c, 0xdc, 0xb3, 0xc9, 0x26, 0x93, 0xd1, 0x7a, 0x0a, 0x14, 0xc5, 0x9f,
    0xa2, 0xdb, 0xb9, 0x4d, 0xde, 0xa6, 0x29, 0x26, 0x61, 0x2f, 0x1d, 0xe0,
    0x23, 0xad, 0x0c, 0x33, 0x90, 0xc3, 0x0b, 0x8f, 0x65, 0x25, 0xd0, 0xb5,
    0x0e, 0x12, 0x34, 0x09, 0x2c, 0xd7, 0xf2, 0x3d, 0xa7, 0xce, 0x36, 0xe8,
    0x62, 0xc5, 0x86, 0x70, 0x6c, 0x42, 0x27, 0x9f, 0xaf, 0x9d, 0xad, 0x63,
    0xae, 0xc7, 0x05, 0xd5, 0x64, 0xd5, 0x40, 0x00, 0x03, 0x8e, 0x31, 0xc7
  };

  uint8_t expected_res[BLS_FIELD_EXT_LEN] = {
    0x06, 0xaf, 0x0e, 0x04, 0x37, 0xff, 0x40, 0x0b, 0x68, 0x31, 0xe3, 0x6d,
    0x6b, 0xd1, 0x7f, 0xfe, 0x48, 0x39, 0x5d, 0xab, 0xc2, 0xd3, 0x43, 0x5e,
    0x77, 0xf7, 0x6e, 0x17, 0x00, 0x92, 0x41, 0xc5, 0xee, 0x67, 0x99, 0x2f,
    0x72, 0xec, 0x05, 0xf4, 0xc8, 0x10, 0x84, 0xfb, 0xed, 0xe3, 0xcc, 0x09,
    0x13, 0x52, 0x03, 0xe6, 0x01, 0x80, 0xa6, 0x8e, 0xe2, 0xe9, 0xc4, 0x48,
    0xd7, 0x7a, 0x2c, 0xd9, 0x1c, 0x3d, 0xed, 0xd9, 0x30, 0xb1, 0xcf, 0x60,
    0xef, 0x39, 0x64, 0x89, 0xf6, 0x1e, 0xb4, 0x5e, 0x30, 0x44, 0x66, 0xcf,
    0x3e, 0x67, 0xfa, 0x0a, 0xf1, 0xee, 0x7b, 0x04, 0x12, 0x1b, 0xde, 0xa2
  };
  uint8_t res[BLS_FIELD_EXT_LEN];

  blst_fp2 fp2_a, fp2_res;

  cx_bls_fp2_from_bendian(&fp2_a, a, a + CX_BLS_BLS12381_PARAM_LEN);
  cx_bls_fp2_pow(&fp2_res, &fp2_a, exponent, sizeof(exponent));
  cx_bls_bendian_from_fp2(res, res + CX_BLS_BLS12381_PARAM_LEN, &fp2_res);

  assert_memory_equal(res, expected_res, sizeof(expected_res));
}

static void test_bls_g2_psi(void **state __attribute__((unused)))
{
  uint8_t point[BLS_FIELD_EXT_LEN * 2] = {
    0x0b, 0x5d, 0xf0, 0xbd, 0x6a, 0x69, 0xc6, 0x1a, 0xf6, 0x60, 0x34, 0x3e,
    0xde, 0x88, 0x35, 0xbe, 0x4b, 0xa2, 0xb1, 0x10, 0x21, 0x40, 0xbd, 0xf1,
    0xe9, 0x78, 0x40, 0x7c, 0x7a, 0xa5, 0x65, 0x11, 0xfd, 0xfd, 0x19, 0x42,
    0x89, 0xf8, 0x71, 0x96, 0x3f, 0x10, 0x9e, 0x2a, 0xe6, 0x62, 0xe0, 0x8b,
    0x02, 0xfc, 0xc7, 0x20, 0x50, 0x22, 0x92, 0xf0, 0x5a, 0x90, 0xe2, 0x4a,
    0xd4, 0x22, 0x7c, 0xa7, 0x9a, 0x10, 0x42, 0xb6, 0xb6, 0xc9, 0x83, 0x53,
    0xba, 0x97, 0xd5, 0xd6, 0xe7, 0x01, 0x21, 0x24, 0x54, 0x8e, 0x07, 0x4f,
    0x9c, 0xda, 0x02, 0x61, 0x66, 0x22, 0xdb, 0x7c, 0x75, 0x09, 0xe4, 0x9f,
    0x06, 0x65, 0x78, 0x4b, 0x34, 0x33, 0x2d, 0x9d, 0xc3, 0x6f, 0x37, 0x44,
    0x05, 0x4a, 0xd2, 0x41, 0xe3, 0xdd, 0xb6, 0x98, 0xe9, 0x77, 0xa7, 0xf3,
    0xb5, 0x1b, 0xe2, 0xd8, 0x63, 0xe8, 0x07, 0xe1, 0x42, 0x55, 0xb3, 0x7f,
    0x12, 0x68, 0xf4, 0x7a, 0x9f, 0x1e, 0x65, 0xfb, 0x5a, 0x8e, 0xb0, 0x17,
    0x10, 0x46, 0x96, 0x42, 0x7a, 0x78, 0x78, 0x26, 0x63, 0x15, 0x0f, 0x26,
    0xed, 0xbd, 0xa2, 0x3d, 0x36, 0x74, 0x6c, 0x9c, 0xfe, 0xde, 0xfa, 0x20,
    0x26, 0xa2, 0xf5, 0x05, 0x43, 0xa2, 0xe4, 0x1c, 0x6b, 0x55, 0xac, 0x3d,
    0xe6, 0xc4, 0x20, 0x8b, 0x3c, 0x52, 0x69, 0xdd, 0xc2, 0x55, 0x65, 0x1a
  };

  uint8_t expected_res[BLS_FIELD_EXT_LEN * 2] = {
    0x0f, 0xdf, 0xdd, 0x8f, 0x70, 0x6a, 0x39, 0xc9, 0xb8, 0x46, 0x57, 0x6f,
    0xa0, 0x1d, 0x0e, 0xa1, 0x9b, 0x9c, 0xba, 0x65, 0x48, 0x19, 0x82, 0x55,
    0xba, 0x77, 0x44, 0x6e, 0xd8, 0xc1, 0x2f, 0x9b, 0x2b, 0x56, 0xe3, 0xeb,
    0x77, 0xaa, 0x0a, 0xb4, 0xc9, 0xb3, 0x67, 0x03, 0xec, 0x6e, 0x31, 0xb6,
    0x02, 0x06, 0x6c, 0xdc, 0xa7, 0x48, 0xe4, 0xde, 0x56, 0xea, 0xc7, 0x8b,
    0xab, 0x3c, 0x64, 0xa1, 0xe5, 0xa1, 0x47, 0xeb, 0x63, 0xeb, 0xfb, 0x5b,
    0xa1, 0xb4, 0x6e, 0x46, 0x19, 0xca, 0x88, 0xfe, 0x85, 0xca, 0x17, 0xaa,
    0xaf, 0xcb, 0xe2, 0x08, 0xab, 0x91, 0x84, 0xb7, 0x50, 0x5a, 0x58, 0xfe,
    0x00, 0xbe, 0x53, 0xe5, 0x00, 0xc4, 0xe2, 0x61, 0x4e, 0x24, 0x53, 0x5f,
    0x1d, 0xd2, 0x64, 0x75, 0xab, 0x2d, 0x43, 0xaa, 0xc0, 0xd3, 0x33, 0xa9,
    0x1a, 0x81, 0xc7, 0x18, 0x9e, 0x11, 0x9c, 0xee, 0x31, 0x8e, 0xfa, 0x84,
    0xae, 0x1b, 0x87, 0x49, 0xa3, 0x15, 0xe0, 0x1a, 0x33, 0x1e, 0x1a, 0xc9,
    0x03, 0x77, 0xdc, 0x2c, 0x0a, 0x65, 0x59, 0x4f, 0x85, 0x7c, 0xee, 0xa7,
    0x78, 0x1c, 0xac, 0x2c, 0x67, 0x90, 0xe2, 0xe6, 0x95, 0x6c, 0x04, 0x2f,
    0x10, 0x9c, 0x02, 0x8f, 0x5f, 0x77, 0xd5, 0x85, 0xcc, 0xb5, 0x38, 0x3a,
    0x46, 0x66, 0x7f, 0x23, 0x77, 0xd0, 0x1e, 0x78, 0x74, 0xf2, 0x6a, 0x07
  };
  uint8_t res[BLS_FIELD_EXT_LEN * 2];

  blst_p2_affine p2_point, p2_ret_point;

  cx_bls_fp2_from_bendian(&p2_point.x, point,
                          point + CX_BLS_BLS12381_PARAM_LEN);
  cx_bls_fp2_from_bendian(&p2_point.y, point + 2 * CX_BLS_BLS12381_PARAM_LEN,
                          point + 3 * CX_BLS_BLS12381_PARAM_LEN);
  cx_bls_g2_psi(&p2_ret_point, &p2_point);
  cx_bls_bendian_from_fp2(res, res + CX_BLS_BLS12381_PARAM_LEN,
                          &p2_ret_point.x);
  cx_bls_bendian_from_fp2(res + 2 * CX_BLS_BLS12381_PARAM_LEN,
                          res + 3 * CX_BLS_BLS12381_PARAM_LEN, &p2_ret_point.y);

  assert_memory_equal(res, expected_res, sizeof(expected_res));
}

static void test_bls_map_curve_simple_swu(void **state __attribute__((unused)))
{
  uint8_t u[96] = { 0x17, 0xfe, 0x92, 0xee, 0x11, 0x29, 0xd5, 0x96, 0x1e, 0x11,
                    0x8e, 0x85, 0x56, 0xb2, 0xe2, 0xb1, 0x8b, 0xcb, 0x87, 0x6d,
                    0x1f, 0xe8, 0xe5, 0xbc, 0xca, 0x50, 0x92, 0xac, 0x9c, 0x13,
                    0xbc, 0x54, 0x0e, 0x6e, 0xdd, 0xb5, 0x10, 0xc3, 0xa7, 0x69,
                    0x90, 0xcd, 0x31, 0x13, 0xc1, 0xf0, 0x71, 0xb3, 0x02, 0xed,
                    0x6b, 0x29, 0x16, 0x13, 0x82, 0x9b, 0xb7, 0x2d, 0xc8, 0x76,
                    0xf8, 0xb6, 0x33, 0xf8, 0xc2, 0xa9, 0x5a, 0xf3, 0xc0, 0xf9,
                    0x59, 0x8c, 0x64, 0x42, 0x1f, 0x79, 0xdb, 0x50, 0x3f, 0x64,
                    0xd7, 0xf7, 0xbb, 0xd0, 0x94, 0x5b, 0xf6, 0xf9, 0x4e, 0x0b,
                    0x3a, 0xd2, 0x5b, 0xeb, 0xbe, 0x1c };
  uint8_t expected_res[BLS_FIELD_EXT_LEN * 2] = {
    0x12, 0xf1, 0x39, 0x61, 0x7f, 0xa7, 0x78, 0x4f, 0xb0, 0x56, 0x92, 0x41,
    0x69, 0xbd, 0xd1, 0x4c, 0xb3, 0xfb, 0x0b, 0x77, 0xfb, 0x2b, 0x58, 0x5b,
    0xf1, 0xfe, 0x9d, 0x84, 0x3a, 0xfc, 0xdf, 0x45, 0x17, 0x78, 0x00, 0x26,
    0xc5, 0xd7, 0xf4, 0x64, 0x1f, 0xf0, 0xbc, 0xc2, 0xa8, 0x89, 0x53, 0x1c,
    0x0e, 0xe2, 0x00, 0x7e, 0x17, 0x2c, 0xad, 0xd2, 0x8e, 0xa9, 0xaf, 0x1a,
    0xeb, 0x58, 0xa2, 0xc4, 0x52, 0xa2, 0x8b, 0xf4, 0x35, 0x99, 0x21, 0xb8,
    0x9d, 0x55, 0xa8, 0x30, 0x29, 0x96, 0x7f, 0xf7, 0x7a, 0x9a, 0x44, 0xc7,
    0x12, 0x7d, 0xfe, 0x85, 0x86, 0x4d, 0x69, 0x6f, 0x23, 0xe1, 0x27, 0x0d,
    0x16, 0x06, 0x65, 0x1c, 0x14, 0x92, 0x89, 0x47, 0xcb, 0x62, 0x65, 0xc8,
    0x78, 0x24, 0xa3, 0x56, 0xaf, 0x07, 0xf0, 0x9e, 0x2c, 0xe2, 0xd9, 0x39,
    0x67, 0x8f, 0xfe, 0x0b, 0x71, 0x6b, 0x10, 0x18, 0x3c, 0x8f, 0x8c, 0x1c,
    0x19, 0x04, 0x72, 0x60, 0x21, 0x0c, 0x42, 0xb9, 0xf7, 0x04, 0x9d, 0x53,
    0x06, 0x2e, 0xd3, 0x54, 0x24, 0xc4, 0x29, 0x69, 0xda, 0xcc, 0x12, 0x90,
    0x94, 0x08, 0x1c, 0xa1, 0x44, 0x47, 0x8e, 0xdb, 0x8f, 0x1a, 0x8a, 0xf5,
    0xe6, 0xb1, 0xd8, 0x78, 0x40, 0xa8, 0xd4, 0xcb, 0x50, 0xa4, 0x13, 0xa5,
    0x3c, 0x04, 0x9d, 0xa4, 0x86, 0xd9, 0x58, 0xa0, 0x12, 0x7d, 0x21, 0x16
  };
  uint8_t res[BLS_FIELD_EXT_LEN * 2];

  blst_fp2 fp2_u;
  blst_p2_affine point;

  cx_bls_fp2_from_bendian(&fp2_u, u, u + CX_BLS_BLS12381_PARAM_LEN);
  cx_bls_g2_map_to_curve_simple_swu(&point, &fp2_u);
  cx_bls_bendian_from_fp2(res, res + CX_BLS_BLS12381_PARAM_LEN, &point.x);
  cx_bls_bendian_from_fp2(res + 2 * CX_BLS_BLS12381_PARAM_LEN,
                          res + 3 * CX_BLS_BLS12381_PARAM_LEN, &point.y);
  assert_memory_equal(res, expected_res, sizeof(expected_res));
}

static void test_bls_iso_map_3(void **state __attribute__((unused)))
{
  uint8_t point[BLS_FIELD_EXT_LEN * 2] = {
    0x01, 0x53, 0xbd, 0x7f, 0x81, 0x39, 0xf1, 0x54, 0x37, 0xe6, 0x8e, 0xac,
    0xc7, 0x68, 0x93, 0xd3, 0xf3, 0x2e, 0x61, 0xa2, 0x46, 0x19, 0x41, 0x87,
    0x94, 0x53, 0x63, 0x84, 0x42, 0x63, 0x16, 0x4f, 0x2e, 0x3a, 0x23, 0xc7,
    0xfa, 0x79, 0x93, 0xb7, 0xa3, 0x78, 0x2e, 0xd5, 0x2f, 0xee, 0x39, 0x82,
    0x14, 0x91, 0xf6, 0x6b, 0x9f, 0xf8, 0x8d, 0xca, 0xfb, 0x9e, 0x97, 0xec,
    0x79, 0xa9, 0x62, 0x48, 0x4c, 0xba, 0x2b, 0xf4, 0xe1, 0xc9, 0xf3, 0x79,
    0xac, 0x6d, 0xc7, 0x49, 0xa0, 0xfe, 0x9a, 0xd8, 0x36, 0x49, 0x18, 0x36,
    0x24, 0x41, 0xed, 0x3f, 0xe1, 0xf8, 0xec, 0x7d, 0xb1, 0x3a, 0x67, 0x68,
    0x00, 0x00, 0x12, 0xf9, 0x2c, 0x7f, 0x8d, 0x31, 0xd4, 0xc2, 0x33, 0xe0,
    0xa5, 0xfd, 0x1a, 0xec, 0xfb, 0xba, 0x73, 0x10, 0x84, 0xdf, 0xfe, 0x96,
    0x41, 0x87, 0xe3, 0x19, 0x16, 0x13, 0x7c, 0x12, 0x41, 0x3f, 0x18, 0x89,
    0x56, 0x6c, 0x21, 0x45, 0x78, 0x85, 0xa7, 0x9c, 0x9e, 0xaf, 0xa0, 0x3d,
    0x00, 0x00, 0x88, 0x2e, 0x3b, 0x86, 0x8b, 0x14, 0x90, 0x55, 0x5d, 0xd1,
    0x41, 0xe6, 0xfb, 0x64, 0x27, 0xd4, 0x40, 0xa2, 0x94, 0x81, 0xd4, 0x56,
    0xcb, 0xd7, 0x36, 0xbe, 0x90, 0xdd, 0xc0, 0x2e, 0x49, 0xb9, 0x79, 0xb7,
    0x9d, 0x4f, 0x1f, 0x7c, 0xe1, 0xc1, 0xef, 0x46, 0xa5, 0xc6, 0xac, 0xf2
  };
  uint8_t expected_res[BLS_FIELD_EXT_LEN * 2] = {
    0x04, 0x76, 0x89, 0x89, 0x87, 0x12, 0xac, 0xd6, 0xe1, 0x8d, 0x02, 0xa9,
    0x9f, 0xe3, 0x87, 0xd8, 0xa6, 0x57, 0xdd, 0xd0, 0x5e, 0xbe, 0xca, 0x51,
    0x48, 0x4e, 0xab, 0x6d, 0x71, 0x6b, 0x4e, 0x6a, 0xb0, 0x92, 0xc9, 0x9d,
    0xa5, 0x9d, 0xca, 0x37, 0x2c, 0x15, 0x3e, 0xdb, 0x58, 0xbf, 0x3b, 0x84,
    0x0e, 0x09, 0xd6, 0x2c, 0x7e, 0xb5, 0xe6, 0x3c, 0xbf, 0xe4, 0xb3, 0xc5,
    0x67, 0x01, 0xcd, 0xb8, 0x06, 0x94, 0xea, 0xb9, 0xfa, 0x1e, 0x62, 0xd3,
    0x86, 0x60, 0x4d, 0x28, 0x15, 0x09, 0x65, 0x47, 0xbc, 0xc9, 0xad, 0x57,
    0x65, 0xb8, 0xb3, 0x28, 0xe9, 0xf5, 0x99, 0xf1, 0xec, 0x84, 0x11, 0xe0,
    0x10, 0xf8, 0xe6, 0xed, 0x06, 0xa1, 0x80, 0x7c, 0x60, 0xd3, 0xe4, 0xf2,
    0x8f, 0xbd, 0x53, 0x5f, 0x3e, 0x27, 0xed, 0x26, 0xf4, 0xcb, 0xd6, 0x46,
    0xa2, 0x29, 0x27, 0x08, 0x6b, 0xd8, 0x96, 0xc9, 0xf6, 0xd2, 0xe1, 0x2e,
    0x00, 0x56, 0xca, 0x7f, 0x05, 0x30, 0x6f, 0x08, 0x42, 0x73, 0x6e, 0x79,
    0x0c, 0x0d, 0x8a, 0x10, 0x63, 0x31, 0x22, 0x76, 0x2e, 0xdf, 0x11, 0xcf,
    0xf3, 0xc9, 0x45, 0xb4, 0x41, 0x5d, 0xaf, 0xc7, 0x57, 0x7b, 0xa7, 0xbb,
    0xf4, 0xaf, 0xf3, 0xaf, 0x1b, 0x70, 0x63, 0x46, 0x73, 0x19, 0x48, 0xb3,
    0xbc, 0x88, 0xfb, 0x45, 0x9f, 0x60, 0x03, 0x3a, 0xea, 0xae, 0x2e, 0x28
  };
  uint8_t res[BLS_FIELD_EXT_LEN * 2];

  blst_p2_affine p2_point, p2_ret_point;

  cx_bls_fp2_from_bendian(&p2_point.x, point,
                          point + CX_BLS_BLS12381_PARAM_LEN);
  cx_bls_fp2_from_bendian(&p2_point.y, point + 2 * CX_BLS_BLS12381_PARAM_LEN,
                          point + 3 * CX_BLS_BLS12381_PARAM_LEN);
  cx_bls_g2_iso_map_3(&p2_ret_point, &p2_point);
  cx_bls_bendian_from_fp2(res, res + CX_BLS_BLS12381_PARAM_LEN,
                          &p2_ret_point.x);
  cx_bls_bendian_from_fp2(res + 2 * CX_BLS_BLS12381_PARAM_LEN,
                          res + 3 * CX_BLS_BLS12381_PARAM_LEN, &p2_ret_point.y);

  assert_memory_equal(res, expected_res, sizeof(expected_res));
}

static void test_bls_clear_cofactor(void **state __attribute__((unused)))
{
  uint8_t point[BLS_FIELD_EXT_LEN * 2] = {
    0x19, 0xad, 0x92, 0x94, 0x4e, 0xa6, 0x8e, 0x91, 0xd8, 0x54, 0x8b, 0xb8,
    0xb5, 0xd3, 0xdd, 0x3e, 0x2b, 0x27, 0x3a, 0x05, 0x47, 0x19, 0x1b, 0xea,
    0xd2, 0xc6, 0x5c, 0x0c, 0x3e, 0x65, 0xfc, 0x1c, 0x92, 0x47, 0x35, 0xcc,
    0x35, 0x42, 0x8e, 0x22, 0x46, 0x55, 0xa8, 0x4b, 0xe3, 0x08, 0x39, 0x7c,
    0x0a, 0xf7, 0x4c, 0xe8, 0xf8, 0xbd, 0x64, 0x1d, 0x93, 0x0e, 0xd5, 0x56,
    0xb7, 0xab, 0x8c, 0x9b, 0x37, 0x01, 0xf3, 0xed, 0xeb, 0xdd, 0x7a, 0xce,
    0x9e, 0x1c, 0xe2, 0x44, 0xc5, 0x7a, 0xda, 0xd0, 0x16, 0x96, 0xa5, 0x99,
    0x05, 0x81, 0x4a, 0x93, 0x61, 0x21, 0x8d, 0x15, 0x77, 0x47, 0xc9, 0xef,
    0x0a, 0xc2, 0x73, 0x0c, 0x53, 0x49, 0xe9, 0xaf, 0xe1, 0xd7, 0x8d, 0xde,
    0x06, 0x86, 0xad, 0xb3, 0xda, 0xa3, 0xfd, 0xe2, 0x9c, 0x4d, 0xa6, 0xd9,
    0x3a, 0xf2, 0x3d, 0x11, 0x2f, 0xfc, 0x58, 0xc4, 0x5c, 0xcc, 0x4c, 0x59,
    0xd8, 0x5f, 0x17, 0x54, 0x83, 0x1f, 0x9e, 0x18, 0x77, 0x45, 0x31, 0x06,
    0x03, 0x10, 0x57, 0x04, 0x71, 0xc4, 0x15, 0x6f, 0xb1, 0xe3, 0xde, 0x96,
    0x0a, 0xe2, 0xd5, 0x43, 0x5a, 0xa5, 0xdc, 0x71, 0xf8, 0x55, 0xff, 0xe5,
    0xe1, 0xf1, 0x8a, 0x46, 0xd2, 0x64, 0xa9, 0x3d, 0xdc, 0x69, 0xac, 0x30,
    0x6f, 0xed, 0x69, 0xf5, 0x4c, 0x3c, 0x96, 0x8d, 0xae, 0x14, 0x92, 0x19
  };

  uint8_t expected_res[BLS_FIELD_EXT_LEN * 2] = {
    0x05, 0x78, 0xc5, 0x3b, 0xf3, 0x9b, 0x29, 0xab, 0xcf, 0x79, 0xf1, 0xda,
    0x7e, 0xb8, 0x7c, 0x6f, 0x6e, 0xdf, 0xde, 0xbd, 0x47, 0xb5, 0xb5, 0x5f,
    0x72, 0x1e, 0x41, 0x85, 0xd2, 0x31, 0x8a, 0x00, 0xfa, 0xbb, 0x12, 0x3d,
    0x6f, 0xef, 0x1a, 0xbc, 0x09, 0xf1, 0xbf, 0xda, 0x12, 0xa9, 0x54, 0x91,
    0x17, 0x3c, 0xac, 0x0f, 0x09, 0xbd, 0x37, 0xf4, 0x58, 0x0a, 0xcd, 0x3d,
    0x4c, 0x33, 0x8b, 0x5f, 0xa1, 0xec, 0x03, 0x18, 0xaa, 0xa8, 0xdb, 0x55,
    0xbd, 0x8d, 0x3b, 0x8f, 0x76, 0xaa, 0xcb, 0x52, 0x8e, 0x3f, 0x58, 0x83,
    0x85, 0x35, 0x53, 0x0a, 0xe8, 0xff, 0xf3, 0x32, 0x13, 0x22, 0xa6, 0x49,
    0x12, 0x79, 0x59, 0x5b, 0x09, 0xdf, 0xba, 0x3f, 0xa5, 0x14, 0x47, 0x0d,
    0x77, 0x5b, 0x2d, 0xc1, 0x9e, 0x02, 0xde, 0x5d, 0xfe, 0x1c, 0x48, 0x3d,
    0x68, 0x89, 0xc4, 0x40, 0x58, 0x1a, 0xb7, 0x50, 0x88, 0xba, 0x47, 0xda,
    0x09, 0xec, 0xb0, 0x5c, 0x90, 0x03, 0xce, 0x66, 0x27, 0xa8, 0x36, 0x47,
    0x0a, 0xd5, 0xe9, 0xf8, 0x6b, 0x58, 0xd2, 0x73, 0xad, 0xc6, 0xb8, 0xc3,
    0x07, 0xeb, 0x47, 0xca, 0x22, 0x93, 0xaf, 0x18, 0xd6, 0xc3, 0xd3, 0xec,
    0x77, 0x58, 0x1f, 0xb4, 0x26, 0x61, 0x29, 0x1e, 0x66, 0x61, 0x2b, 0x1a,
    0x12, 0x03, 0x10, 0xea, 0xfa, 0xc7, 0xc7, 0xa4, 0xc6, 0x83, 0x45, 0xf9
  };
  uint8_t res[BLS_FIELD_EXT_LEN * 2];

  blst_p2_affine p2_point, p2_ret_point;
  cx_bls_fp2_from_bendian(&p2_point.x, point,
                          point + CX_BLS_BLS12381_PARAM_LEN);
  cx_bls_fp2_from_bendian(&p2_point.y, point + 2 * CX_BLS_BLS12381_PARAM_LEN,
                          point + 3 * CX_BLS_BLS12381_PARAM_LEN);
  cx_bls_g2_clear_cofactor(&p2_ret_point, &p2_point);
  cx_bls_bendian_from_fp2(res, res + CX_BLS_BLS12381_PARAM_LEN,
                          &p2_ret_point.x);
  cx_bls_bendian_from_fp2(res + 2 * CX_BLS_BLS12381_PARAM_LEN,
                          res + 3 * CX_BLS_BLS12381_PARAM_LEN, &p2_ret_point.y);

  assert_memory_equal(res, expected_res, sizeof(expected_res));
}

static void test_bls_hash_to_curve(void **state __attribute__((unused)))
{
  uint8_t hash[BLS_FIELD_EXT_LEN * 2] = {
    0x03, 0xdb, 0xc2, 0xcc, 0xe1, 0x74, 0xe9, 0x1b, 0xa9, 0x3c, 0xbb, 0x08,
    0xf2, 0x6b, 0x91, 0x7f, 0x98, 0x19, 0x4a, 0x2e, 0xa0, 0x8d, 0x1c, 0xce,
    0x75, 0xb2, 0xb9, 0xcc, 0x9f, 0x21, 0x68, 0x9d, 0x80, 0xbd, 0x79, 0xb5,
    0x94, 0xa6, 0x13, 0xd0, 0xa6, 0x8e, 0xb8, 0x07, 0xdf, 0xdc, 0x1c, 0xf8,
    0x05, 0xa2, 0xac, 0xec, 0x64, 0x11, 0x48, 0x45, 0x71, 0x1a, 0x54, 0x19,
    0x9e, 0xa3, 0x39, 0xab, 0xd1, 0x25, 0xba, 0x38, 0x25, 0x3b, 0x70, 0xa9,
    0x2c, 0x87, 0x6d, 0xf1, 0x05, 0x98, 0xbd, 0x19, 0x86, 0xb7, 0x39, 0xca,
    0xd6, 0x79, 0x61, 0xeb, 0x94, 0xf7, 0x07, 0x65, 0x11, 0xb3, 0xb3, 0x9a,
    0x02, 0xf9, 0x97, 0x98, 0xe8, 0xa5, 0xac, 0xde, 0xed, 0x60, 0xd7, 0xe1,
    0x8e, 0x91, 0x20, 0x52, 0x1b, 0xa1, 0xf4, 0x7e, 0xc0, 0x90, 0x98, 0x46,
    0x62, 0x84, 0x6b, 0xc8, 0x25, 0xde, 0x19, 0x1b, 0x5b, 0x76, 0x41, 0x14,
    0x8c, 0x0d, 0xbc, 0x23, 0x77, 0x26, 0xa3, 0x34, 0x47, 0x3e, 0xee, 0x94,
    0x14, 0x5a, 0x81, 0xe4, 0x18, 0xd4, 0x01, 0x0c, 0xc0, 0x27, 0xa6, 0x8f,
    0x14, 0x39, 0x1b, 0x30, 0x07, 0x4e, 0x89, 0xe6, 0x0e, 0xe7, 0xa2, 0x2f,
    0x87, 0x21, 0x7b, 0x2f, 0x6e, 0xb0, 0xc4, 0xb9, 0x4c, 0x91, 0x15, 0xb4,
    0x36, 0xe6, 0xfa, 0x46, 0x07, 0xe9, 0x5a, 0x98, 0xde, 0x30, 0xa4, 0x35
  };

  uint8_t expected_res[BLS_FIELD_EXT_LEN * 2] = {
    0x01, 0x41, 0xeb, 0xfb, 0xdc, 0xa4, 0x0e, 0xb8, 0x5b, 0x87, 0x14, 0x2e,
    0x13, 0x0a, 0xb6, 0x89, 0xc6, 0x73, 0xcf, 0x60, 0xf1, 0xa3, 0xe9, 0x8d,
    0x69, 0x33, 0x52, 0x66, 0xf3, 0x0d, 0x9b, 0x8d, 0x4a, 0xc4, 0x4c, 0x10,
    0x38, 0xe9, 0xdc, 0xdd, 0x53, 0x93, 0xfa, 0xf5, 0xc4, 0x1f, 0xb7, 0x8a,
    0x05, 0xcb, 0x84, 0x37, 0x53, 0x5e, 0x20, 0xec, 0xff, 0xae, 0xf7, 0x75,
    0x2b, 0xad, 0xdf, 0x98, 0x03, 0x41, 0x39, 0xc3, 0x84, 0x52, 0x45, 0x8b,
    0xae, 0xef, 0xab, 0x37, 0x9b, 0xa1, 0x3d, 0xff, 0x5b, 0xf5, 0xdd, 0x71,
    0xb7, 0x24, 0x18, 0x71, 0x70, 0x47, 0xf5, 0xb0, 0xf3, 0x7d, 0xa0, 0x3d,
    0x05, 0x03, 0x92, 0x1d, 0x7f, 0x6a, 0x12, 0x80, 0x5e, 0x72, 0x94, 0x0b,
    0x96, 0x3c, 0x0c, 0xf3, 0x47, 0x1c, 0x7b, 0x2a, 0x52, 0x49, 0x50, 0xca,
    0x19, 0x5d, 0x11, 0x06, 0x2e, 0xe7, 0x5e, 0xc0, 0x76, 0xda, 0xf2, 0xd4,
    0xbc, 0x35, 0x8c, 0x4b, 0x19, 0x0c, 0x0c, 0x98, 0x06, 0x4f, 0xdd, 0x92,
    0x12, 0x42, 0x4a, 0xc3, 0x25, 0x61, 0x49, 0x3f, 0x3f, 0xe3, 0xc2, 0x60,
    0x70, 0x8a, 0x12, 0xb7, 0xc6, 0x20, 0xe7, 0xbe, 0x00, 0x09, 0x9a, 0x97,
    0x4e, 0x25, 0x9d, 0xdc, 0x7d, 0x1f, 0x63, 0x95, 0xc3, 0xc8, 0x11, 0xcd,
    0xd1, 0x9f, 0x1e, 0x8d, 0xbf, 0x3e, 0x9e, 0xcf, 0xdc, 0xba, 0xb8, 0xd6
  };
  uint8_t res[BLS_FIELD_EXT_LEN * 2] = { 0 };

  blst_p2_affine ret_point;
  cx_bls_g2_hash_field_to_curve(&ret_point, hash, sizeof(hash));
  cx_bls_bendian_from_fp2(res, res + 48, &ret_point.x);
  cx_bls_bendian_from_fp2(res + 96, res + 3 * 48, &ret_point.y);

  assert_memory_equal(res, expected_res, sizeof(expected_res));
}

static void test_bls_sign(void **state __attribute__((unused)))
{
  uint8_t sk[CX_BLS_BLS12381_PARAM_LEN] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x05, 0xd5, 0x3a, 0xf5, 0xc6, 0x77, 0x3b, 0x60,
    0xf7, 0x92, 0x71, 0xf0, 0x71, 0x7d, 0x1b, 0xd4, 0x57, 0x3d, 0x99, 0xad,
    0xa4, 0x02, 0x2e, 0x9a, 0x23, 0x85, 0x9a, 0x2a, 0x1e, 0xb4, 0x0e, 0x04
  };
  uint8_t hash[BLS_FIELD_EXT_LEN * 2] = {
    0x15, 0xf7, 0xc0, 0xaa, 0x8f, 0x6b, 0x29, 0x6a, 0xb5, 0xff, 0x9c, 0x2c,
    0x75, 0x81, 0xad, 0xe6, 0x4f, 0x4e, 0xe6, 0xf1, 0xbf, 0x18, 0xf5, 0x51,
    0x79, 0xff, 0x44, 0xa2, 0xcf, 0x35, 0x5f, 0xa5, 0x3d, 0xd2, 0xa2, 0x15,
    0x8c, 0x5e, 0xcb, 0x17, 0xd7, 0xc5, 0x2f, 0x63, 0xe7, 0x19, 0x57, 0x71,
    0x01, 0xc8, 0x06, 0x7b, 0xf4, 0xc0, 0xba, 0x70, 0x9a, 0xa8, 0xb9, 0xab,
    0xc3, 0xd1, 0xce, 0xf5, 0x89, 0xa4, 0x75, 0x8e, 0x09, 0xef, 0x53, 0x73,
    0x2d, 0x67, 0x0f, 0xd8, 0x73, 0x9a, 0x72, 0x74, 0xe1, 0x11, 0xba, 0x2f,
    0xca, 0xa7, 0x1b, 0x3d, 0x33, 0xdf, 0x2a, 0x3a, 0x0c, 0x85, 0x29, 0xdd,
    0x18, 0x71, 0x11, 0xd5, 0xe0, 0x88, 0xb6, 0xb9, 0xac, 0xfd, 0xfa, 0xd0,
    0x78, 0xc4, 0xda, 0xcf, 0x72, 0xdc, 0xd1, 0x7c, 0xa1, 0x7c, 0x82, 0xbe,
    0x35, 0xe7, 0x9f, 0x8c, 0x37, 0x2a, 0x69, 0x3f, 0x60, 0xa0, 0x33, 0xb4,
    0x61, 0xd8, 0x1b, 0x02, 0x58, 0x64, 0xa0, 0xad, 0x05, 0x1a, 0x06, 0xe4,
    0x08, 0xb8, 0x52, 0x33, 0x1c, 0x96, 0xed, 0x98, 0x3e, 0x49, 0x7e, 0xbc,
    0x6d, 0xee, 0x9b, 0x75, 0xe3, 0x73, 0xd9, 0x23, 0xb7, 0x29, 0x19, 0x4a,
    0xf8, 0xe7, 0x2a, 0x05, 0x1e, 0xa5, 0x86, 0xf3, 0x53, 0x8a, 0x6e, 0xbb,
    0x1e, 0x80, 0x88, 0x1a, 0x08, 0x2f, 0xa2, 0xb2, 0x4d, 0xf9, 0xf5, 0x66
  };
  uint8_t expected_signature[BLS_FIELD_EXT_LEN] = {
    0x88, 0x88, 0xcf, 0x9e, 0x00, 0xc2, 0xbb, 0xfa, 0xf9, 0x41, 0x00, 0xfa,
    0x54, 0x9b, 0x8d, 0xfd, 0xe2, 0xad, 0xfb, 0x91, 0x2b, 0xfd, 0x3d, 0x12,
    0x46, 0x97, 0x60, 0x4d, 0x6d, 0xa5, 0x3b, 0xb3, 0x8a, 0x75, 0x66, 0xbd,
    0x50, 0x0f, 0x6d, 0xa1, 0x36, 0x60, 0x7e, 0xa1, 0xc7, 0xb9, 0xf0, 0x0f,
    0x08, 0xac, 0xe7, 0x56, 0x07, 0x8f, 0xe0, 0x6f, 0x1d, 0xf5, 0x36, 0xcf,
    0x78, 0xe2, 0x61, 0x2c, 0x4f, 0x45, 0xc2, 0x45, 0xfa, 0xa4, 0xc4, 0xa1,
    0x23, 0x50, 0xf9, 0x8e, 0x06, 0xee, 0xd9, 0x91, 0x7a, 0x2e, 0x8a, 0x70,
    0x3d, 0x64, 0x34, 0xca, 0xe0, 0xe7, 0xa7, 0x67, 0x2b, 0x7f, 0xf5, 0x0a
  };
  uint8_t signature[BLS_FIELD_EXT_LEN];

  cx_ecfp_384_private_key_t key;
  sys_cx_ecfp_init_private_key(CX_CURVE_BLS12_381_G1, sk, sizeof(sk),
                               (cx_ecfp_private_key_t *)&key);
  sys_ox_bls12381_sign(&key, hash, sizeof(hash), signature, sizeof(signature));

  assert_memory_equal(signature, expected_signature,
                      sizeof(expected_signature));
}

static void test_bls_aggregate(void **state __attribute__((unused)))
{
  uint8_t sig1[BLS_COMPRESSED_SIG_LEN] = {
    0xb6, 0xed, 0x93, 0x67, 0x46, 0xe0, 0x1f, 0x8e, 0xcf, 0x28, 0x1f, 0x02,
    0x09, 0x53, 0xfb, 0xf1, 0xf0, 0x1d, 0xeb, 0xd5, 0x65, 0x7c, 0x4a, 0x38,
    0x39, 0x40, 0xb0, 0x20, 0xb2, 0x65, 0x07, 0xf6, 0x07, 0x63, 0x34, 0xf9,
    0x1e, 0x23, 0x66, 0xc9, 0x6e, 0x9a, 0xb2, 0x79, 0xfb, 0x51, 0x58, 0x09,
    0x03, 0x52, 0xea, 0x1c, 0x5b, 0x0c, 0x92, 0x74, 0x50, 0x4f, 0x4f, 0x0e,
    0x70, 0x53, 0xaf, 0x24, 0x80, 0x2e, 0x51, 0xe4, 0x56, 0x8d, 0x16, 0x4f,
    0xe9, 0x86, 0x83, 0x4f, 0x41, 0xe5, 0x5c, 0x8e, 0x85, 0x0c, 0xe1, 0xf9,
    0x84, 0x58, 0xc0, 0xcf, 0xc9, 0xab, 0x38, 0x0b, 0x55, 0x28, 0x5a, 0x55
  };
  uint8_t sig2[BLS_COMPRESSED_SIG_LEN] = {
    0xb2, 0x3c, 0x46, 0xbe, 0x3a, 0x00, 0x1c, 0x63, 0xca, 0x71, 0x1f, 0x87,
    0xa0, 0x05, 0xc2, 0x00, 0xcc, 0x55, 0x0b, 0x94, 0x29, 0xd5, 0xf4, 0xeb,
    0x38, 0xd7, 0x43, 0x22, 0x14, 0x4f, 0x1b, 0x63, 0x92, 0x6d, 0xa3, 0x38,
    0x89, 0x79, 0xe5, 0x32, 0x10, 0x12, 0xfb, 0x1a, 0x05, 0x26, 0xbc, 0xd1,
    0x00, 0xb5, 0xef, 0x5f, 0xe7, 0x26, 0x28, 0xce, 0x4c, 0xd5, 0xe9, 0x04,
    0xae, 0xaa, 0x32, 0x79, 0x52, 0x78, 0x43, 0xfa, 0xe5, 0xca, 0x9c, 0xa6,
    0x75, 0xf4, 0xf5, 0x1e, 0xd8, 0xf8, 0x3b, 0xbf, 0x71, 0x55, 0xda, 0x9e,
    0xcc, 0x96, 0x63, 0x10, 0x0a, 0x88, 0x5d, 0x5d, 0xc6, 0xdf, 0x96, 0xd9
  };
  uint8_t sig3[BLS_COMPRESSED_SIG_LEN] = {
    0x94, 0x8a, 0x7c, 0xb9, 0x9f, 0x76, 0xd6, 0x16, 0xc2, 0xc5, 0x64, 0xce,
    0x9b, 0xf4, 0xa5, 0x19, 0xf1, 0xbe, 0xa6, 0xb0, 0xa6, 0x24, 0xa0, 0x22,
    0x76, 0x44, 0x3c, 0x24, 0x58, 0x54, 0x21, 0x9f, 0xab, 0xb8, 0xd4, 0xce,
    0x06, 0x1d, 0x25, 0x5a, 0xf5, 0x33, 0x0b, 0x07, 0x8d, 0x53, 0x80, 0x68,
    0x17, 0x51, 0xaa, 0x70, 0x53, 0xda, 0x2c, 0x98, 0xba, 0xe8, 0x98, 0xed,
    0xc2, 0x18, 0xc7, 0x5f, 0x07, 0xe2, 0x4d, 0x88, 0x02, 0xa1, 0x7c, 0xd1,
    0xf6, 0x83, 0x3b, 0x71, 0xe5, 0x8f, 0x5e, 0xb5, 0xb9, 0x42, 0x08, 0xb4,
    0xd0, 0xbb, 0x38, 0x48, 0xce, 0xcb, 0x07, 0x5e, 0xa2, 0x1b, 0xe1, 0x15
  };
  uint8_t expected_signature[BLS_COMPRESSED_SIG_LEN] = {
    0x96, 0x83, 0xb3, 0xe6, 0x70, 0x1f, 0x9a, 0x4b, 0x70, 0x67, 0x09, 0x57,
    0x79, 0x63, 0x11, 0x00, 0x43, 0xaf, 0x78, 0xa5, 0xb4, 0x19, 0x91, 0xb9,
    0x98, 0x47, 0x5a, 0x3d, 0x3f, 0xd6, 0x2a, 0xbf, 0x35, 0xce, 0x03, 0xb3,
    0x39, 0x08, 0x41, 0x8e, 0xfc, 0x95, 0xa0, 0x58, 0x49, 0x4a, 0x8a, 0xe5,
    0x04, 0x35, 0x4b, 0x9f, 0x62, 0x62, 0x31, 0xf6, 0xb3, 0xf3, 0xc8, 0x49,
    0xdf, 0xde, 0xaf, 0x50, 0x17, 0xc4, 0x78, 0x0e, 0x2a, 0xee, 0x18, 0x50,
    0xce, 0xaf, 0x4b, 0x4d, 0x9c, 0xe7, 0x09, 0x71, 0xa3, 0xd2, 0xcf, 0xcd,
    0x97, 0xb7, 0xe5, 0xec, 0xf6, 0x75, 0x9f, 0x8d, 0xa5, 0xf7, 0x6d, 0x31
  };
  uint8_t signature[BLS_COMPRESSED_SIG_LEN];

  sys_cx_bls12381_aggregate(sig1, sizeof(sig1), true, signature,
                            sizeof(signature));
  sys_cx_bls12381_aggregate(sig2, sizeof(sig2), false, signature,
                            sizeof(signature));
  sys_cx_bls12381_aggregate(sig3, sizeof(sig3), false, signature,
                            sizeof(signature));

  assert_memory_equal(signature, expected_signature,
                      sizeof(expected_signature));
}

int main(void)
{
  const struct CMUnitTest tests[] = { cmocka_unit_test(test_bls_key_gen_aug),
                                      cmocka_unit_test(test_bls_sign_aug),
                                      cmocka_unit_test(test_bls_hash_to_field),
                                      cmocka_unit_test(test_bls_fp2_pow),
                                      cmocka_unit_test(test_bls_fp2_sqrt_ratio),
                                      cmocka_unit_test(test_bls_g2_psi),
                                      cmocka_unit_test(
                                          test_bls_map_curve_simple_swu),
                                      cmocka_unit_test(test_bls_iso_map_3),
                                      cmocka_unit_test(test_bls_clear_cofactor),
                                      cmocka_unit_test(test_bls_hash_to_curve),
                                      cmocka_unit_test(test_bls_sign),
                                      cmocka_unit_test(test_bls_aggregate) };
  return cmocka_run_group_tests(tests, NULL, NULL);
}
